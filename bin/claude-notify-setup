#!/bin/bash
# claude-notify-setup -- Install hooks for Claude Code and/or OpenCode
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Find the hook script: check Homebrew share, then relative to this script
HOOK_SRC=""
BREW_SHARE="$(brew --prefix 2>/dev/null)/share/claude-notify/notify-complete.sh"
RELATIVE_HOOK="$(dirname "$SCRIPT_DIR")/share/claude-notify/notify-complete.sh"
REPO_HOOK="$(dirname "$SCRIPT_DIR")/hooks/notify-complete.sh"

if [ -f "$BREW_SHARE" ]; then
    HOOK_SRC="$BREW_SHARE"
elif [ -f "$RELATIVE_HOOK" ]; then
    HOOK_SRC="$RELATIVE_HOOK"
elif [ -f "$REPO_HOOK" ]; then
    HOOK_SRC="$REPO_HOOK"
else
    echo "Error: Could not find notify-complete.sh"
    echo "Make sure claude-notify is properly installed."
    exit 1
fi

echo "claude-notify setup"
echo "==================="
echo ""

# --- Claude Code ---
setup_claude_code() {
    local hooks_dir="$HOME/.claude/hooks"
    local settings="$HOME/.claude/settings.json"

    mkdir -p "$hooks_dir"
    cp "$HOOK_SRC" "$hooks_dir/notify-complete.sh"
    chmod +x "$hooks_dir/notify-complete.sh"
    echo "[OK] Hook script installed to $hooks_dir/notify-complete.sh"

    # Patch settings.json if it exists, or create it
    if [ -f "$settings" ]; then
        # Check if Stop hook is already configured
        if python3 -c "
import json, sys
with open('$settings') as f:
    s = json.load(f)
hooks = s.get('hooks', {})
stops = hooks.get('Stop', [])
for stop in stops:
    for h in stop.get('hooks', []):
        if 'notify-complete' in h.get('command', ''):
            sys.exit(0)
sys.exit(1)
" 2>/dev/null; then
            echo "[OK] Claude Code settings already configured (Stop hook found)"
        else
            # Add the Stop hook
            python3 -c "
import json
with open('$settings') as f:
    s = json.load(f)
s.setdefault('hooks', {})
stop_entry = {
    'hooks': [{
        'type': 'command',
        'command': 'bash \"\$HOME/.claude/hooks/notify-complete.sh\"',
        'timeout': 60
    }]
}
s['hooks'].setdefault('Stop', [])
s['hooks']['Stop'].append(stop_entry)
with open('$settings', 'w') as f:
    json.dump(s, f, indent=2)
" 2>/dev/null
            echo "[OK] Claude Code settings.json updated with Stop hook"
        fi
    else
        # Create settings.json with hook config
        mkdir -p "$(dirname "$settings")"
        python3 -c "
import json
s = {
    'hooks': {
        'Stop': [{
            'hooks': [{
                'type': 'command',
                'command': 'bash \"\$HOME/.claude/hooks/notify-complete.sh\"',
                'timeout': 60
            }]
        }]
    }
}
with open('$settings', 'w') as f:
    json.dump(s, f, indent=2)
" 2>/dev/null
        echo "[OK] Created $settings with Stop hook"
    fi
}

# --- OpenCode ---
setup_opencode() {
    local hooks_dir="$HOME/.config/opencode/hooks"
    local settings="$HOME/.config/opencode/settings.json"

    mkdir -p "$hooks_dir"
    cp "$HOOK_SRC" "$hooks_dir/notify-complete.sh"
    chmod +x "$hooks_dir/notify-complete.sh"
    echo "[OK] Hook script installed to $hooks_dir/notify-complete.sh"

    if [ -f "$settings" ]; then
        if python3 -c "
import json, sys
with open('$settings') as f:
    s = json.load(f)
hooks = s.get('hooks', {})
stops = hooks.get('Stop', [])
for stop in stops:
    for h in stop.get('hooks', []):
        if 'notify-complete' in h.get('command', ''):
            sys.exit(0)
sys.exit(1)
" 2>/dev/null; then
            echo "[OK] OpenCode settings already configured (Stop hook found)"
        else
            python3 -c "
import json
with open('$settings') as f:
    s = json.load(f)
s.setdefault('hooks', {})
stop_entry = {
    'hooks': [{
        'type': 'command',
        'command': 'bash \"\$HOME/.config/opencode/hooks/notify-complete.sh\"',
        'timeout': 60
    }]
}
s['hooks'].setdefault('Stop', [])
s['hooks']['Stop'].append(stop_entry)
with open('$settings', 'w') as f:
    json.dump(s, f, indent=2)
" 2>/dev/null
            echo "[OK] OpenCode settings.json updated with Stop hook"
        fi
    else
        echo "[SKIP] OpenCode settings.json not found (OpenCode not installed?)"
    fi
}

# --- Editor Config ---

# Map number to config key
editor_key_for() {
    case "$1" in
        1) echo "zed" ;;
        2) echo "vscode" ;;
        3) echo "cursor" ;;
        4) echo "windsurf" ;;
        5) echo "void" ;;
        6) echo "sublime" ;;
        7) echo "fleet" ;;
        8) echo "nova" ;;
        9) echo "warp" ;;
        *) echo "" ;;
    esac
}

setup_editor() {
    local config_dir="$HOME/.config/claude-notify"
    local config_file="$config_dir/config"

    echo "Which editors/terminals do you use?"
    echo "(Pick one, or multiple separated by commas -- e.g. 1,3,9)"
    echo ""
    echo "  1) Zed"
    echo "  2) VS Code"
    echo "  3) Cursor"
    echo "  4) Windsurf"
    echo "  5) Void"
    echo "  6) Sublime Text"
    echo "  7) Fleet"
    echo "  8) Nova"
    echo "  9) Warp (terminal)"
    echo ""
    read -rp "Choice: " editor_input

    # Parse comma-separated choices
    local selected=()
    IFS=',' read -ra picks <<< "$editor_input"
    for pick in "${picks[@]}"; do
        pick=$(echo "$pick" | tr -d ' ')
        local key
        key=$(editor_key_for "$pick")
        if [ -n "$key" ]; then
            selected+=("$key")
        fi
    done

    # Fallback if nothing valid was selected
    if [ ${#selected[@]} -eq 0 ]; then
        echo "No valid selection, defaulting to Zed."
        selected=("zed")
    fi

    mkdir -p "$config_dir"

    if [ ${#selected[@]} -eq 1 ]; then
        echo "EDITOR=${selected[0]}" > "$config_file"
        echo "[OK] Editor set to ${selected[0]} (saved to $config_file)"
    else
        local joined
        joined=$(IFS=','; echo "${selected[*]}")
        echo "EDITORS=$joined" > "$config_file"
        echo "[OK] Editors set to $joined (saved to $config_file)"
        echo "     The notification panel will show a button for each."
    fi
}

# Prompt user for which runtimes to configure
echo "Which runtimes do you want to configure?"
echo ""
echo "  1) Claude Code only"
echo "  2) OpenCode only"
echo "  3) Both"
echo ""
read -rp "Choice [1/2/3]: " choice

echo ""

case "$choice" in
    1)
        setup_claude_code
        ;;
    2)
        setup_opencode
        ;;
    3)
        setup_claude_code
        echo ""
        setup_opencode
        ;;
    *)
        echo "Invalid choice. Run again and pick 1, 2, or 3."
        exit 1
        ;;
esac

echo ""
setup_editor

echo ""
echo "Done! Restart your runtime for changes to take effect."
